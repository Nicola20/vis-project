<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Videogame Visualisation</title>
    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- for icons -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">

    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/multiple-select/1.2.2/multiple-select.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/multiple-select/1.2.2/multiple-select.min.css">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">

    <script src="https://d3js.org/d3.v4.min.js"></script>

</head>
<body>

    <div class="tabhandle">
        <i class="fas fa-filter" style="font-size: 28px; color: white; transform: translateX(80%) translateY(40%);"></i>
    </div>

    <div id="barchart"></div>
    <div id="genre_pie"></div>
    <div id="filter-container">
        <div id="header">
            <span><strong>FILTER</strong></span>
        </div>
        <div>
            <!--
            <form>
                <select id="categorySelect" class="multiSelect" multiple="multiple">
                    <option value="1">Flood</option>
                    <option value="2">Hurricane</option>
                    <option value="3">Manmade</option>
                    <option value="4">Earthquake</option>
                    <option value="5">Fire</option>
                </select>
            </form>-->
        </div>
    </div>



<script type="module">

    $('.tabhandle').click(function(e) {
        var filter = $('#filter-container');
        if(filter.css("display") == "none") {
            filter.css("display", "inline-block");
            $(this).css("margin-left", "calc(25% - 10px)");
        } else {
            filter.css("display", "none");
            $(this).css("margin-left", "-10px");
        }

        });

    const xAxisLabelText = 'Global Sales';

    var xValue;
    var yValue;
    var xScale;
    var yScale;
    var g;
    var data;
    
    function render(data) {
        const width = 800;
        const height = Object.keys(data).length * 30;
        data = data;

        //console.log("sizing= " + height + ", " + width);

        xValue = d => d.global_sales;
        yValue = d => d.name;
        
        const margin = { top: 50, right: 70, bottom: 77, left: 180+132 };
        const innerWidth = width - margin.left - margin.right;
        const innerHeight = height - margin.top - margin.bottom;

        xScale = d3.scaleLinear()
            .domain([0, d3.max(data, xValue)])
            .range([0, innerWidth]);
  
        yScale = d3.scaleBand()
            .domain(data.map(yValue))
            .range([0, innerHeight])
            .padding(0.1);

        var svg = d3.select('#barchart').append('svg')
            .attr("id", "barsvg")
            .attr("width" , width)
            .attr("height", height)

        g = svg.append('g')
            .attr('transform', `translate(${margin.left},${margin.top})`);

        var defs = svg.append("defs");

        createGradiens(defs);

        const xAxisTickFormat = number =>
            d3.format('.3s')(number)
            .replace('G', 'B');
  
        const xAxis = d3.axisBottom(xScale)
            .tickFormat(xAxisTickFormat)
            .tickSize(-innerHeight);

        g.append('g')
            .call(d3.axisLeft(yScale))
            .selectAll('.domain, .tick line')
            .remove();

        const xAxisG = g.append('g').call(xAxis)
            .attr('transform', `translate(0,${innerHeight})`);
  
        xAxisG.select('.domain').remove(); //deletes the line of the x axis
  
        xAxisG.append('text')
            .attr('class', 'axis-label')
            .attr('y', 35)
            .attr('x', innerWidth / 2)
            .text(xAxisLabelText);
      
        g.selectAll('rect').data(data)
            .enter().append('rect')
            .on("mouseover", mouseoverBar)
            .on("mouseleave", mouseleaveBar)
            .attr('y', d => yScale(yValue(d)))
            .attr('width', d => xScale(xValue(d)))
            .attr('height', yScale.bandwidth() - 5)
            .style("fill", function(d) { return color(d.platform);});

    }

    function mouseoverBar(d, i) {
        var hover = d3.select(this);
        hover.transition()
           .duration(200)
           .attr('width', d => xScale(xValue(d)) + 5)
           .attr("y", d => yScale(yValue(d)) - 2.5)
           .attr("height", yScale.bandwidth() + 1);

        hover.style("fill", "red");
        hover.style("cursor", "pointer");

        var size = (d.global_sales/1000000) + " M";
        size = size.length;
    /*
        g.selectAll('.textRect').data(data)
            .enter().append('rect')
            .attr("class", "text-background")
            .attr('y', d => yScale(yValue(d)))
            .attr('x' , d => xScale(xValue(d)) + 15)
            .attr('width', '60')
            .attr('height', yScale.bandwidth() - 5)
            .style("fill", "#263238")*/

        g.append("text")
            .attr("class", "salesHover")
            .attr('x', function() {
                return xScale(d.global_sales) + 15;
            })
            .attr('y', function() {
                return yScale(d.name) + 18; //stimmt schonmal von der HÃ¶he her
            })
            .text(function() { return (d.global_sales/1000000) + "M";});

    }

    function mouseleaveBar(d, i) {
        d3.selectAll('.salesHover')
            .remove()

        var hover = d3.select(this);
        hover.transition()
           .duration(200)
           .attr('y', d => yScale(yValue(d)))
           .attr('width', d => xScale(xValue(d)))
           .attr('height', yScale.bandwidth() - 5)
           .style("fill", function(d) { return color(d.platform);});

    }


    function color(platform) {
        if (platform == "DS")
            return 'url(#dsGradient)';
        if (platform == "PS2")
            return 'url(#ps2Gradient)';
        if (platform == "PS3")
            return 'url(#ps3Gradient)';
        else
            return 'url(#linear-gradient)';
    }

    function createGradiens(defs) {
        var linearGradient = defs.append("linearGradient")
            .attr("id", "linear-gradient");

        linearGradient
            .attr("x1", "0%")
            .attr("y1", "0%")
            .attr("x2", "100%")
            .attr("y2", "0%");

        //Set the color for the start (0%)
        linearGradient.append("stop")
            .attr("offset", "0%")
            .attr("stop-color", "#7283a7");

        //Set the color for the end (100%)
        linearGradient.append("stop")
            .attr("offset", "100%")
            .attr("stop-color", "#1c2a48");


        var dsGradient = defs.append("linearGradient")
            .attr("id", "dsGradient");

        dsGradient
            .attr("x1", "0%")
            .attr("y1", "0%")
            .attr("x2", "100%")
            .attr("y2", "0%");

        //Set the color for the start (0%)
        dsGradient.append("stop")
            .attr("offset", "0%")
            .attr("stop-color", "#ff6ec4");

        //Set the color for the end (100%)
        dsGradient.append("stop")
            .attr("offset", "100%")
            .attr("stop-color", "#7873f5");

        var ps2Gradient = defs.append("linearGradient")
            .attr("id", "ps2Gradient");

        ps2Gradient
            .attr("x1", "0%")
            .attr("y1", "0%")
            .attr("x2", "100%")
            .attr("y2", "0%");

        //Set the color for the start (0%)
        ps2Gradient.append("stop")
            .attr("offset", "0%")
            .attr("stop-color", "#2096ff");

        //Set the color for the end (100%)
        ps2Gradient.append("stop")
            .attr("offset", "100%")
            .attr("stop-color", "#05ffa3");


        var ps3Gradient = defs.append("linearGradient")
            .attr("id", "ps3Gradient");

        ps3Gradient
            .attr("x1", "0%")
            .attr("y1", "0%")
            .attr("x2", "100%")
            .attr("y2", "0%");

        //Set the color for the start (0%)
        ps3Gradient.append("stop")
            .attr("offset", "0%")
            .attr("stop-color", "#ffd86f");

        //Set the color for the end (100%)
        ps3Gradient.append("stop")
            .attr("offset", "100%")
            .attr("stop-color", "#fc6262");

        var wiiGradient = defs.append("linearGradient")
            .attr("id", "wiiGradient");

        wiiGradient
            .attr("x1", "0%")
            .attr("y1", "0%")
            .attr("x2", "100%")
            .attr("y2", "0%");

        //Set the color for the start (0%)
        wiiGradient.append("stop")
            .attr("offset", "0%")
            .attr("stop-color", "#ffd86f");

        //Set the color for the end (100%)
        wiiGradient.append("stop")
            .attr("offset", "100%")
            .attr("stop-color", "#fc6262");
    }

   
    fetch("../static/data.json")
        .then(file => file.json())
        .then(data => render(data.slice(0, 50)));




</script>


</body>

</html>