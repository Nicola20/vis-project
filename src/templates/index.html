<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Videogame Sunburst</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}"></link>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <!-- <script src="https://d3js.org/d3.v5.min.js"></script> -->

</head>
<body>


<div class="container">
    <div class="barchart-container">
        <svg id="barchart" width="600" height="1300"></svg>
    </div>




    <div class="pie-chart-container">
        
        <form>
            <button type="button" id="toggle-sales"></button>
        </form>
        <div class="test">
            <div id="platform-container"></div>
            <div id="genre-container"></div>
            <div id="publisher-container"></div>
        </div>
    </div>
</div>



<script type="text/javascript">


// -------------------------------------------------------------------------
// LOAD DATA
// -------------------------------------------------------------------------

    var data = [];

    $.ajax({
        url: '../static/data.json',
        async: false,
        dataType: 'json',
        success: function (json) {
            data = json;
        }
    });

    data = data.slice(0, 100);
            





// -------------------------------------------------------------------------
// CONSTANTS
// -------------------------------------------------------------------------


    const size = 800 
    const radius = (size / 2) - 200;

    var scaleBySales = false;
    const kindOfSales = "global_sales";


// -------------------------------------------------------------------------
// BUTTONS
// -------------------------------------------------------------------------

    var toggleSalesButton = document.getElementById("toggle-sales");
    toggleSalesButton.addEventListener("click", toggle);

    function toggle() {
        if (scaleBySales) {
            scaleBySales = false;
        } else {
            scaleBySales = true;
        }
        render(data);
    }


// -------------------------------------------------------------------------
// PIE-CHART
// -------------------------------------------------------------------------


    // ---------------------------------------------------------------------
    // HELPERS
    // ---------------------------------------------------------------------


    function getFeatureDataForPie(data, feature, scaleBySales, kindOfSales) {
        const featureData = [];

        for (var i = 0; i < data.length; i++) {
            var featureKey = data[i][feature];
            var flag = true;
            for (var j = 0; j < featureData.length; j++) {
                if (featureData[j].key == featureKey) {
                    if (scaleBySales) {
                        featureData[j].value += data[i][kindOfSales];
                    } else {
                        featureData[j].value += 1;
                    }
                    flag = false;
                    break;
                } 
            }
            if (flag) {
                if (scaleBySales) {
                    featureData.push({"key" : featureKey, "value" : data[i][kindOfSales]});
                } else {
                    featureData.push({"key" : featureKey, "value" : 1});
                }
            }
        }

        return featureData;
    }


    function getClassForPie(d) {
        var c = "arc ";
        c += d.data.key.replace(/ /g, "-");
        return c;
    }


    // ---------------------------------------------------------------------
    // MOUSE-EVENTS
    // ---------------------------------------------------------------------


    function mouseoverPie(d) {
        //change opacity of pie
        d3.select(this)
            .style("opacity", "1.0");
        //change color of bar
        d3.selectAll(".rect." + this.parentElement.classList[1])
            .attr("fill", "red");
        //show info in middle of pie
        d3.selectAll(".info." + d.data.key.replace(/ /g, "-"))
        .style("opacity", "1.0");
    }


    function mouseoutPie(d) {
        //change opacity of pie
        d3.select(this)
            .style("opacity", "0.5")
        //change color of bar
        d3.selectAll(".rect." + this.parentElement.classList[1])
            .attr("fill", "black");
        //hide info in middle of pie
        d3.selectAll(".info." + d.data.key.replace(/ /g, "-"))
            .style("opacity", "0.0");
    }

    function onclickPie(d) {
        d.select(this).addEventListener("click", onclickPie);
    }


    // ---------------------------------------------------------------------
    // RENDERING
    // ---------------------------------------------------------------------

    function renderArcs(svg, pie, featureData, arc, color) {

        var g = svg.selectAll(".arc")
            .data(pie(featureData))
            .enter()
            .append("g")
            .attr("transform", "translate(" + (size / 2) + "," + (size / 2) + ")")
            .attr("class", getClassForPie);

        g.append("path")
            .attr("d", arc)
            .style("fill", color)
            .style("stroke", "black")
            .style("opacity", "0.5")
            .on("mouseover", mouseoverPie)
            .on("mouseout", mouseoutPie)
            .on("click", onclickPie);
    }


    function renderLabels(svg, pie, featureData) {
        var textArc = d3.arc()
            .innerRadius(radius * 1.45)
            .outerRadius(radius * 1.45);

        svg.selectAll(".label")
            .data(pie(featureData))
            .enter()
            .append("text")
            .attr("transform", "translate(" + (size/ 2) + "," + (size / 2) + ")")
            .attr("dy", ".35em")
            .attr("class", "label")
            .attr("fill", "white")
            .attr('transform', function(d) {
                var pos = textArc.centroid(d);
                var midangle = d.startAngle + (d.endAngle - d.startAngle) / 2
                pos[0] += (size / 2);
                pos[1] += (size / 2);
                return 'translate(' + pos + ')';
            })
            .style('text-anchor', function(d) {
                var midangle = d.startAngle + (d.endAngle - d.startAngle) / 2
                return (midangle < Math.PI ? 'start' : 'end')
            })
            .text(d => {
                if ((d.endAngle - d.startAngle) / (2 * Math.PI) * 100 > 2) {
                    return d.data.key;
                }
            });

    }


    function renderLines(svg, pie, featureData, arc) {
        var textArc = d3.arc()
            .innerRadius(radius * 1.4)
            .outerRadius(radius * 1.4);

        svg.selectAll(".line")
            .data(pie(featureData))
            .enter()
            .append("polyline")
            .attr("transform", "translate(" + (size/ 2) + "," + (size / 2) + ")")
            .attr("stroke", "white")
            .style("fill", "none")
            .attr("stroke-width", "2")
            .attr("points", d => {
                if ((d.endAngle - d.startAngle) / (2 * Math.PI) * 100 > 2) {
                    var posA = arc.centroid(d);
                    var posB = textArc.centroid(d);
          
                    return [posA, posB];
                }
            });
    }


    function renderInfo(svg, pie, featureData) {
         svg.selectAll(".info.key")
            .data(pie(featureData))
            .enter()
            .append("text")
            .attr("transform", "translate(" + (size/ 2) + "," + (size / 2) + ")")
            .attr("dy", "-1.5%")
            .attr("class", d => {
                return "info key " + d.data.key.replace(/ /g, "-")
            })
            .attr("fill", "white")
            .style("opacity", "0.0")
            .style("text-anchor", "middle")
            .text(d => d.data.key);

        var format = d3.format(".1f");

        svg.selectAll(".info.percent")
            .data(pie(featureData))
            .enter()
            .append("text")
            .attr("transform", "translate(" + (size/ 2) + "," + (size / 2) + ")")
            .attr("dy", "1.5%")
            .attr("class", d => {
                return "info percent " + d.data.key.replace(/ /g, "-")
            })
            .attr("fill", "white")
            .style("opacity", "0.0")
            .style("text-anchor", "middle")
            .text(d => format((d.endAngle - d.startAngle) / (2 * Math.PI) * 100) + " %");
    }


    function renderPieChart(data, feature, color, scaleBySales, kindOfSales) {
        d3.select("#"  + feature).remove();
        d3.select("#"  + feature + "-container")
            .append("svg")
            .attr("id", feature)
            .attr("width", size)
            .attr("height", size);


        const svg = d3.select("#" + feature);

        var pie = d3.pie()
            .value(d => d.value);

        var arc = d3.arc()
            .innerRadius(radius - 100)
            .outerRadius(radius);

        const featureData = getFeatureDataForPie(data, feature, scaleBySales, kindOfSales);

        renderArcs(svg, pie, featureData, arc, color);
        renderLabels(svg, pie, featureData);
        renderLines(svg, pie, featureData, arc);
        renderInfo(svg, pie, featureData);
    }


    function renderPies(data) {
        renderPieChart(data, "platform", "blue", scaleBySales, kindOfSales);
        renderPieChart(data, "genre", "yellow", scaleBySales, kindOfSales);
        renderPieChart(data, "publisher", "red", scaleBySales, kindOfSales);
    }


// -------------------------------------------------------------------------
// BAR-CHART
// -------------------------------------------------------------------------


    // ---------------------------------------------------------------------
    // HELPERS
    // ---------------------------------------------------------------------


    function getClassForBar(d) {
        var c = "rect ";
        c += d.platform.replace(/ /g, "-") + " ";
        c += d.genre.replace(/ /g, "-") + " ";
        c += d.publisher.replace(/ /g, "-");
        return c;
    }


    // ---------------------------------------------------------------------
    // MOUSE-EVENTS
    // ---------------------------------------------------------------------


    function mouseoverBar(d) {
        d3.select(this)
            .attr("fill", "red");

        d3.selectAll(".arc." + this.classList[1] + " path")
            .style("opacity", "1.0");
        d3.selectAll(".arc." + this.classList[2] + " path")
            .style("opacity", "1.0");
        d3.selectAll(".arc." + this.classList[3] + " path")
            .style("opacity", "1.0");
    }


    function mouseoutBar(d) {
        d3.select(this)
            .attr("fill", "black");
                
        d3.selectAll(".arc." + this.classList[1] + " path")
            .style("opacity", "0.5");
        d3.selectAll(".arc." + this.classList[2] + " path")
            .style("opacity", "0.5");
        d3.selectAll(".arc." + this.classList[3] + " path")
            .style("opacity", "0.5");
    }


    // ---------------------------------------------------------------------
    // RENDERING
    // ---------------------------------------------------------------------


    function renderBar(data) {

        const svg = d3.select("#barchart");

        const width = +svg.attr('width');
        const height = +svg.attr('height');

        const xAxisLabelText = 'Value';

        const xValue = d => d.global_sales;
        const yValue = d => d.name;
        
        const margin = { top: 50, right: 40, bottom: 77, left: 180 };
        const innerWidth = width - margin.left - margin.right;
        const innerHeight = height - margin.top - margin.bottom;

        const xScale = d3.scaleLinear()
            .domain([0, d3.max(data, xValue)])
            .range([0, innerWidth]);
  
        const yScale = d3.scaleBand()
            .domain(data.map(yValue))
            .range([0, innerHeight])
            .padding(0.1);


        const g = svg.append('g')
            .attr('transform', `translate(${margin.left},${margin.top})`);

        const xAxisTickFormat = number =>
            d3.format('.3s')(number)
            .replace('G', 'B');
  
        const xAxis = d3.axisBottom(xScale)
            .tickFormat(xAxisTickFormat)
            .tickSize(-innerHeight);

        g.append('g')
            .call(d3.axisLeft(yScale))
            .selectAll('.domain, .tick line')
            .remove();

        const xAxisG = g.append('g').call(xAxis)
            .attr('transform', `translate(0,${innerHeight})`);
  
        xAxisG.select('.domain').remove();
  
        xAxisG.append('text')
            .attr('class', 'axis-label')
            .attr('y', 65)
            .attr('x', innerWidth / 2)
            .attr('fill', 'black')
            .text(xAxisLabelText);
      
        g.selectAll('rect').data(data)
            .enter().append('rect')
            .attr("class", getClassForBar)
            .attr('y', d => yScale(yValue(d)))
            .attr('width', d => xScale(xValue(d)))
            .attr('height', yScale.bandwidth())
            .style("opacity", "1.0")
            .on("mouseover", mouseoverBar)
            .on("mouseout", mouseoutBar);


    }
    


// -------------------------------------------------------------------------
// 
// -------------------------------------------------------------------------
    function render(data) {
        renderBar(data);
        renderPies(data);
      }
        
   

render(data);



</script>


</body>

</html>